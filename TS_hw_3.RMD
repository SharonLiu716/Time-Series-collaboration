---
title: "TS hw.3"
author: "L, YanShao"
date: "2022-11-11"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

針對 HW2 所收集的 3 個大盤指數與 3 個相關匯率指數，執行以下步驟：
1. 針對每一筆原始資料，檢定是否需要差分
2. 針對每一筆資料，討論是否具有週期性
3. 分別對每一筆資料建立一適合的時間序列模型
Step 1: Plot a time series format
Step 2: Difference to make stationary on mean by removing the trend
Step 3: Make stationary by applying log transform ?
Step 4: Difference log transform to make as stationary on both statistic mean and variance
Step 5: Plot ACF & PACF, and identify the potential AR and MA model
Step 6: Discovery of best fit ARIMA model
Step 7: Forecast/Predict the value, using the best fit ARIMA model
Step 8: Plot ACF & PACF for residuals of the model, and ensure no more information is left.

```{r lib, include=FALSE}
library(zoo)
library(xts)
library(TTR)
library(quantmod)# Finance data
library(ggplot2)
library(magrittr)
library(broom)
library(qpcR)   
library(fpp2)
library(fUnitRoots)
library(stats)
```



```{r ,include=FALSE}
getSymbols("^GSPC", from ='2012-10-12', to = '2022-10-12')
GSPC <- as.xts(data.frame(GSPC = GSPC[, "GSPC.Adjusted"]))
names(GSPC) = c("GSPC")
index(GSPC) = as.Date(index(GSPC))
logrt.GSPC <- apply( log(GSPC) , 2 , diff )*100
rt.GSPC <- (exp(apply( log(GSPC) , 2 , diff ))-1)*100

getSymbols("^N225", from ='2012-10-12', to = '2022-10-12')
N225 <- as.xts(data.frame(N225 = N225[, "N225.Adjusted"]))
N225 <- na.omit(N225)
names(N225) = c("N225")
index(N225) = as.Date(index(N225))
logrt.N225 <- apply( log(N225) , 2 , diff )*100
rt.N225 <- (exp(apply( log(N225) , 2 , diff ))-1)*100

getSymbols("^GDAXI", from ='2012-10-12', to = '2022-10-12')
GDAXI <- as.xts(data.frame(GDAXI = GDAXI[, "GDAXI.Adjusted"]))
GDAXI <- na.omit(GDAXI)
names(GDAXI) = c("GDAXI")
index(GDAXI) = as.Date(index(GDAXI))

getSymbols("USDGBP=X", from = '2012-10-12', to = '2022-10-12')
USDGBP<-as.xts(data.frame(`USDGBP=X` = `USDGBP=X`[, paste0("USDGBP=X.Adjusted")]))
USDGBP<-na.omit(USDGBP)
names(USDGBP) = c("USDGBP")
index(USDGBP) = as.Date(index(USDGBP))

res <- function(data){
  
  acf(data, lag.max = 30)
#  title(paste("ACF","of",name), line = 0)
  
  pacf(data, lag.max = 30)
#  title(paste("PACF","of",name), line = 0.3)
  
}

# Check aic and it's order given max.p & max.q
detect <- function(data,p,q){
  temp <- c()
  ord <- c()
  for (i in 0:p) {
    for (j in 0:q) {
      if (i == 0 & j==0) next
      temp <- c(temp,arima(data,order = c(i,0,j))$aic)
      ord <- rbind(ord, c(i,0,j))
    }
  }
  list(likelihood = sort(temp),order = ord[order(temp), ])
}

a <- rbind(c(1,0,2),c(1,0,4),c(1,0,5))
a
a[c(3,1,2),]
order(c(1,6,2,5,4))
```





```{r GSPC, warning=FALSE}
plot(GSPC,main=names(GSPC))
adfTest(GSPC,type = "ct")
res(GSPC)

plot(diff(GSPC),main=names(GSPC))
adfTest(diff(GSPC),type = "ct")
res(diff(GSPC)[-1])# p=9, q=2

# determine the order
auto.arima(diff(GSPC),max.p = 9, max.q = 2)
arima(diff(GSPC), order = c(0,0,2))
detect(diff(GSPC), p = 9, q = 2)

fit.GSPC <- arima(diff(GSPC), order = c(6,0,2))
fit.GSPC
fit.GSPC <- arima(diff(GSPC), order = c(6,0,2),
                  fixed = c(NA,NA,0,0,NA,NA,NA,NA,NA))
fit.GSPC
fit.GSPC$residuals[-1] %>% res()
tsdiag(fit.GSPC)

```
H_o:beta=1 vs H1:beta<1


# 這個沒有要用(因為跟GSPC同為美洲)
```{r VIX,warning=FALSE}
plot(VIX,main=names(Price_data[[2]]))
# adfTest(Price_data[[2]],type = "ct")
# adfTest(Price_data[[2]],type = "c")
adfTest(VIX,type = "nc")
res(VIX)#(5,?)

adfTest(diff(VIX),type = "nc")
res(diff(VIX)[-1])#(9,4)

auto.arima(diff(VIX))#(2,0,2)
detect(diff(VIX), p = 9, q = 4)
fit.VIX <- arima(diff(VIX), order = c(9,0,4))
fit.VIX
fit.VIX <- arima(diff(VIX), order = c(9,0,4),transform.pars = F,
                  fixed = c(NA,0,NA,NA,0,NA,0,0,NA,NA,NA,NA,NA,NA))

fit.VIX
fit.VIX$residuals[-1] %>% res()
tsdiag(fit.VIX)
```

# 德國
```{r}
plot(GDAXI,main=names(GDAXI))
adfTest(GDAXI,type = "ct")
res(GDAXI)

plot(diff(GDAXI),main=names(GDAXI))
adfTest(diff(GDAXI),type = "ct")
res(diff(GDAXI)[-1])
```


```{r, warning=FALSE}
plot(N225,main=names(N225))
adfTest(N225,type = "c")
res(N225)

plot(diff(N225),main=names(N225))
adfTest(diff(N225),type = "c")
res(diff(N225)[-1])# p = 3

auto.arima(diff(N225))
detect(diff(N225), 3, 3)
fit.N225 <- arima(diff(N225), order = c(3,0,0))
fit.N225
fit.N225 <- arima(diff(N225), order = c(3,0,0),transform.pars = F,
                  fixed = c(0,NA,0,NA))

fit.N225
fit.N225$residuals[-1] %>% res()
tsdiag(fit.N225)
```



